<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Map view</title>

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>

    <!-- Geocoder (search bar) -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>

    <style>
      body, html { margin: 0; padding: 0; height: 100%; width:100%; }
      #map { position: absolute; top: 0; bottom: 0; width:100%; }

      /* Put search bar next to the zoom buttons (top-left) */
      .mapboxgl-ctrl-top-left { display: flex; flex-direction: row; align-items: flex-start; gap: 8px; }
      .mapboxgl-ctrl-top-left .mapboxgl-ctrl { margin: 2px !important; }
      .mapboxgl-ctrl-geocoder { min-width: 240px; width: 240px; }

      /* Floating legend */
      .legend-wrap{
        position: absolute;
        right: 12px;
        bottom: 12px;
        z-index: 10;
        background: rgba(20, 20, 20, 0.78);
        color: #fff;
        border-radius: 10px;
        padding: 10px 10px 8px 10px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        min-width: 230px;
        max-width: 260px;
        backdrop-filter: blur(6px);
      }
      .legend-title{
        font-size: 13px;
        font-weight: 700;
        margin: 0 0 6px 0;
        opacity: 0.95;
      }
      .legend-item{
        margin-top: 10px;
      }
      .legend-item:first-child{
        margin-top: 0;
      }
      .legend-label{
        font-size: 12px;
        font-weight: 700;
        margin: 0 0 6px 0;
      }
      .legend-bar{
        width: 100%;
        height: 16px;
        border-radius: 6px;
        display: block;
      }
      .legend-minmax{
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        opacity: 0.9;
        margin-top: 4px;
      }
      .legend-hidden{
        display: none;
      }
    </style>
  </head>

  <body>
    <script id="mapbox-key" type="text/plain">__MAPBOX_KEY__</script>

    <div id="map"></div>

    <!-- Floating legend container -->
    <div id="legendWrap" class="legend-wrap legend-hidden">
      <div class="legend-title">Legend</div>

      <div id="legendLST" class="legend-item legend-hidden">
        <div class="legend-label">__LST_LEGEND_TITLE__</div>
        <img class="legend-bar" src="__LST_LEGEND_URL__" alt="LST legend" />
        <div class="legend-minmax">
          <span>__LST_VMIN__</span>
          <span>__LST_VMAX__</span>
        </div>
      </div>

      <div id="legendSUHI" class="legend-item legend-hidden">
        <div class="legend-label">__SUHI_LEGEND_TITLE__</div>
        <img class="legend-bar" src="__SUHI_LEGEND_URL__" alt="SUHI legend" />
        <div class="legend-minmax">
          <span>__SUHI_VMIN__</span>
          <span>__SUHI_VMAX__</span>
        </div>
      </div>
    </div>

    <script>
      mapboxgl.accessToken =
        document.getElementById("mapbox-key").textContent.trim();

      // ---- Injected overlay values from Dashboard.py ----
      const LST_URL = "__LST_URL__";
      const SUHI_URL = "__SUHI_URL__";

      const LST_COORDS = __LST_COORDS__;   // [[w,n],[e,n],[e,s],[w,s]]
      const SUHI_COORDS = __SUHI_COORDS__;

      const SHOW_LST = __SHOW_LST__;
      const SHOW_SUHI = __SHOW_SUHI__;

      const LST_OPACITY = __LST_OPACITY__;
      const SUHI_OPACITY = __SUHI_OPACITY__;

      // Default view: North Rhine-Westphalia (NRW)
      const map = new mapboxgl.Map({
        container: "map",
        style: "__STYLE_URL__",
        center: [7.5550, 51.4783],
        pitch: 25,
        bearing: 0,
        zoom: 8.5
      });

      // Zoom buttons only (top-left)
      map.addControl(
        new mapboxgl.NavigationControl({ showZoom: true, showCompass: false }),
        "top-left"
      );

      // Search bar + zoom + boundary bbox
      const geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        mapboxgl: mapboxgl,
        marker: false,
        placeholder: "Search a place..."
      });
      map.addControl(geocoder, "top-left");

      let lastSearchBbox = null;

      function drawSearchBoundaryFromBbox(bbox) {
        const west = bbox[0], south = bbox[1], east = bbox[2], north = bbox[3];

        const poly = {
          "type": "FeatureCollection",
          "features": [{
            "type": "Feature",
            "properties": {},
            "geometry": {
              "type": "Polygon",
              "coordinates": [[
                [west, south],
                [east, south],
                [east, north],
                [west, north],
                [west, south]
              ]]
            }
          }]
        };

        if (map.getLayer("search-boundary-line")) map.removeLayer("search-boundary-line");
        if (map.getLayer("search-boundary-fill")) map.removeLayer("search-boundary-fill");
        if (map.getSource("search-boundary")) map.removeSource("search-boundary");

        map.addSource("search-boundary", { type: "geojson", data: poly });

        map.addLayer({
          id: "search-boundary-fill",
          type: "fill",
          source: "search-boundary",
          paint: { "fill-opacity": 0.08 }
        });

        map.addLayer({
          id: "search-boundary-line",
          type: "line",
          source: "search-boundary",
          paint: { "line-width": 2 }
        });
      }

      geocoder.on("result", (e) => {
        const r = e.result;

        if (r && r.bbox && r.bbox.length === 4) {
          lastSearchBbox = r.bbox;

          map.fitBounds(
            [[r.bbox[0], r.bbox[1]], [r.bbox[2], r.bbox[3]]],
            { padding: 40 }
          );

          if (map.isStyleLoaded()) drawSearchBoundaryFromBbox(lastSearchBbox);
          return;
        }

        if (r && r.geometry && r.geometry.coordinates) {
          map.flyTo({ center: r.geometry.coordinates, zoom: 12 });
          lastSearchBbox = null;
        }
      });

      // Compass / north arrow only (top-right)
      map.addControl(
        new mapboxgl.NavigationControl({ showZoom: false, showCompass: true }),
        "top-right"
      );

      // Scale bar (bottom-left)
      map.addControl(
        new mapboxgl.ScaleControl({ maxWidth: 120, unit: "metric" }),
        "bottom-left"
      );

      // Legend show/hide based on overlay selection
      function updateLegendVisibility() {
        const wrap = document.getElementById("legendWrap");
        const lst = document.getElementById("legendLST");
        const suhi = document.getElementById("legendSUHI");

        const showAny = (SHOW_LST === true) || (SHOW_SUHI === true);

        if (!showAny) {
          wrap.classList.add("legend-hidden");
          lst.classList.add("legend-hidden");
          suhi.classList.add("legend-hidden");
          return;
        }

        wrap.classList.remove("legend-hidden");

        if (SHOW_LST === true) lst.classList.remove("legend-hidden");
        else lst.classList.add("legend-hidden");

        if (SHOW_SUHI === true) suhi.classList.remove("legend-hidden");
        else suhi.classList.add("legend-hidden");
      }

      // âœ… style.load so overlays + 3D buildings (+ boundary) re-add on basemap change
      map.on("style.load", () => {

        // 1) Raster overlays
        if (map.getLayer("lst_layer")) map.removeLayer("lst_layer");
        if (map.getSource("lst_src")) map.removeSource("lst_src");
        if (map.getLayer("suhi_layer")) map.removeLayer("suhi_layer");
        if (map.getSource("suhi_src")) map.removeSource("suhi_src");

        if (LST_URL && LST_URL.startsWith("data:image") && Array.isArray(LST_COORDS)) {
          map.addSource("lst_src", {
            type: "image",
            url: LST_URL,
            coordinates: LST_COORDS
          });

          map.addLayer({
            id: "lst_layer",
            type: "raster",
            source: "lst_src",
            layout: { visibility: SHOW_LST ? "visible" : "none" },
            paint: { "raster-opacity": LST_OPACITY }
          });
        }

        if (SUHI_URL && SUHI_URL.startsWith("data:image") && Array.isArray(SUHI_COORDS)) {
          map.addSource("suhi_src", {
            type: "image",
            url: SUHI_URL,
            coordinates: SUHI_COORDS
          });

          map.addLayer({
            id: "suhi_layer",
            type: "raster",
            source: "suhi_src",
            layout: { visibility: SHOW_SUHI ? "visible" : "none" },
            paint: { "raster-opacity": SUHI_OPACITY }
          });
        }

        // 2) 3D buildings
        const layers = map.getStyle().layers || [];
        const labelLayer = layers.find((l) => l.type === "symbol" && l.layout && l.layout["text-field"]);
        const labelLayerId = labelLayer ? labelLayer.id : null;

        if (map.getLayer("add-3d-buildings")) {
          map.removeLayer("add-3d-buildings");
        }

        if (labelLayerId) {
          map.addLayer(
            {
              id: "add-3d-buildings",
              source: "composite",
              "source-layer": "building",
              filter: ["==", ["get", "extrude"], "true"],
              type: "fill-extrusion",
              minzoom: 15,
              paint: {
                "fill-extrusion-color": "#ffffff",
                "fill-extrusion-height": [
                  "interpolate",
                  ["linear"],
                  ["zoom"],
                  15, 0,
                  15.05, ["get", "height"]
                ],
                "fill-extrusion-base": [
                  "interpolate",
                  ["linear"],
                  ["zoom"],
                  15, 0,
                  15.05, ["get", "min_height"]
                ],
                "fill-extrusion-opacity": 1.0
              }
            },
            labelLayerId
          );
        }

        // 3) Re-draw boundary after basemap/style changes
        if (lastSearchBbox) {
          drawSearchBoundaryFromBbox(lastSearchBbox);
        }

        // 4) Legend visibility
        updateLegendVisibility();
      });

      // run once on first load
      updateLegendVisibility();
    </script>
  </body>
</html>
