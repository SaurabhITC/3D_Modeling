<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Heat Stress Map</title>

  <!-- MapLibre (token-free) -->
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>

  <style>
    html, body { margin: 0; height: 100%; background: #0f0f12; }
    #map { position: relative; height: 500px; width: 100%; border-radius: 16px; overflow: hidden; }

    /* MapLibre control spacing */
    .maplibregl-ctrl-top-left .maplibregl-ctrl { margin: 10px 0 0 10px; }
    .maplibregl-ctrl-top-right .maplibregl-ctrl { margin: 10px 10px 0 0; }
    .maplibregl-ctrl-top-right { top: 0px; } /* very top-right */

    .search-ctrl{
      position:absolute;
      left:12px;
      top:12px;
      z-index:80;
    }
    .search-wrap{
      width: 280px;
      height: 44px;
      display:flex;
      align-items:center;
      background: #ffffff;
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      border: 1px solid rgba(0,0,0,0.10);
      overflow:hidden;
    }
    .search-input{
      flex:1;
      height: 44px;
      padding: 0 14px 0 16px;
      border: 0;
      outline: none;
      background: transparent;
      color: #111;
      font: 600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .search-input::placeholder{
      color: rgba(0,0,0,0.55);
      font-weight: 600;
    }
    .search-icon-btn{
      width: 44px;
      height: 44px;
      border: 0;
      background: transparent;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .search-icon-btn svg{
      width: 20px;
      height: 20px;
      fill: rgba(0,0,0,0.75);
    }
    .search-icon-btn:hover svg{
      fill: rgba(0,0,0,0.95);
    }

    .legend{
      position:absolute; right:14px; bottom:14px; z-index:55;
      width: 250px;
      background: rgba(18,18,20,0.90);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px 10px 8px 10px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
    }
    .legend h4{
      margin: 0 0 8px 0;
      font: 900 12px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.90);
      letter-spacing: 0.3px;
    }
    .legend-item{ margin-bottom: 10px; }
    .legend-label{
      font: 800 11px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.82);
      margin-bottom: 6px;
    }
    .legend-bar{
      width: 100%;
      height: 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.10);
      display:block;
    }
    .legend-minmax{
      display:flex; justify-content:space-between;
      font: 650 11px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: rgba(255,255,255,0.78);
      margin-top: 4px;
    }
    .hidden{ display:none; }
  </style>
</head>

<body>
  <div id="map">
    
    <div class="search-ctrl">
      <div class="search-wrap">
        <input id="searchBox" class="search-input" type="text" placeholder="Search" />
        <button id="searchBtn" class="search-icon-btn" type="button" aria-label="Search">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M10 2a8 8 0 105.293 14.293l4.707 4.707 1.414-1.414-4.707-4.707A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/>
          </svg>
        </button>
      </div>
    </div>

    <div id="legendBox" class="legend hidden">
      <h4>Legend</h4>

      <div id="legendLST" class="legend-item hidden">
        <div class="legend-label">LST (°C)</div>
        <img class="legend-bar" src="__LST_LEGEND_URL__" alt="LST legend" />
        <div class="legend-minmax">
          <span>__LST_VMIN__</span>
          <span>__LST_VMAX__</span>
        </div>
      </div>

      <div id="legendSUHI" class="legend-item hidden">
        <div class="legend-label">SUHI (°C)</div>
        <img class="legend-bar" src="__SUHI_LEGEND_URL__" alt="SUHI legend" />
        <div class="legend-minmax">
          <span>__SUHI_VMIN__</span>
          <span>__SUHI_VMAX__</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Token-free basemap (OSM raster)
    // =========================
    const OSM_RASTER_STYLE = {
      "version": 8,
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": [
            "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
            "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
          ],
          "tileSize": 256,
          "attribution": "© OpenStreetMap contributors"
        }
      },
      "layers": [
        { "id": "osm", "type": "raster", "source": "osm" }
      ]
    };

    const CENTER = __CENTER__;
    const ZOOM = __ZOOM__;
    const FIT_BOUNDS = __FIT_BOUNDS__;

    const SHOW_LST = __SHOW_LST__;
    const SHOW_SUHI = __SHOW_SUHI__;

    const LST_URL = "__LST_URL__";
    const SUHI_URL = "__SUHI_URL__";

    const LST_COORDS = __LST_COORDS__;
    const SUHI_COORDS = __SUHI_COORDS__;

    const LST_OPACITY = parseFloat("__LST_OPACITY__");
    const SUHI_OPACITY = parseFloat("__SUHI_OPACITY__");

    const map = new maplibregl.Map({
      container: "map",
      style: OSM_RASTER_STYLE,
      center: CENTER,
      zoom: ZOOM,
      pitch: 0,
      bearing: 0,
      antialias: true
    });

    // Right-top stack: compass/triangle + +/- then fullscreen below
    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.addControl(new maplibregl.FullscreenControl(), "top-right");
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: "metric" }));

    // -------------------------
    // Search (OSM Nominatim)
    // -------------------------
    async function geocodeNominatim(q) {
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(q);
      const r = await fetch(url, { headers: { "Accept": "application/json" } });
      const data = await r.json();
      if (!data || !data.length) return null;
      return { lon: parseFloat(data[0].lon), lat: parseFloat(data[0].lat) };
    }

    async function doSearch() {
      const box = document.getElementById("searchBox");
      const q = (box.value || "").trim();
      if (!q) return;

      const btn = document.getElementById("searchBtn");
      btn.disabled = true;

      try {
        const p = await geocodeNominatim(q);
        if (!p) return;
        map.flyTo({ center: [p.lon, p.lat], zoom: Math.max(map.getZoom(), 12), duration: 900 });
      } catch (e) {
        // ignore
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("searchBtn").addEventListener("click", doSearch);
    document.getElementById("searchBox").addEventListener("keydown", (e) => {
      if (e.key === "Enter") doSearch();
    });

    // -------------------------
    // Overlay helpers
    // -------------------------
    function dataUrlToBlobUrl(dataUrl) {
      try {
        if (!dataUrl || typeof dataUrl !== "string") return dataUrl;
        if (!dataUrl.startsWith("data:")) return dataUrl;

        const parts = dataUrl.split(",");
        if (parts.length < 2) return dataUrl;

        const header = parts[0];
        const b64 = parts[1];

        const m = header.match(/data:(.*);base64/);
        const mime = (m && m[1]) ? m[1] : "image/png";

        const byteChars = atob(b64);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) byteNumbers[i] = byteChars.charCodeAt(i);

        const blob = new Blob([new Uint8Array(byteNumbers)], { type: mime });
        return URL.createObjectURL(blob);
      } catch (e) {
        return dataUrl;
      }
    }

    function addRaster(id, url, coords, opacity) {
      if (!url || !coords || coords.length !== 4) return;

      const safeUrl = dataUrlToBlobUrl(url);

      if (map.getSource(id)) {
        const lyr = id + "_layer";
        if (map.getLayer(lyr)) map.setPaintProperty(lyr, "raster-opacity", opacity);
        return;
      }

      map.addSource(id, { type: "image", url: safeUrl, coordinates: coords });
      map.addLayer({
        id: id + "_layer",
        type: "raster",
        source: id,
        paint: { "raster-opacity": opacity }
      });
    }

    function ensureRasters() {
      if (SHOW_LST) addRaster("LST", LST_URL, LST_COORDS, LST_OPACITY);
      if (SHOW_SUHI) addRaster("SUHI", SUHI_URL, SUHI_COORDS, SUHI_OPACITY);
    }

    function updateLegend() {
      const box = document.getElementById("legendBox");
      const lst = document.getElementById("legendLST");
      const suhi = document.getElementById("legendSUHI");

      const any = (SHOW_LST && LST_URL) || (SHOW_SUHI && SUHI_URL);
      box.classList.toggle("hidden", !any);

      if (lst) lst.classList.toggle("hidden", !(SHOW_LST && LST_URL));
      if (suhi) suhi.classList.toggle("hidden", !(SHOW_SUHI && SUHI_URL));
    }

    map.on("style.load", () => {
      ensureRasters();
      updateLegend();
    });

    map.on("load", () => {
      ensureRasters();
      if (FIT_BOUNDS && Array.isArray(FIT_BOUNDS)) {
        map.fitBounds(FIT_BOUNDS, { padding: 80, duration: 0 });
      }
      updateLegend();
    });
  </script>
</body>
</html>
